name: ci

on:
    push:
        branches: [main]

jobs:
    deploy:
        name: Build and Deploy
        runs-on: ubuntu-latest

        env:
            DBCONNSTR: ${{ secrets.DBCONNSTR }}
            MUX_TOKEN_SECRET: ${{ secrets.MUX_TOKEN_SECRET }}
            MUX_TOKEN_ID: ${{ secrets.MUX_TOKEN_ID }}
            DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
            DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
            DO_REGISTRY_ENDPOINT: ${{ secrets.DO_REGISTRY_ENDPOINT }}
            DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
            DISCORD_WEBHOOK_SECRET: ${{ secrets.DISCORD_WEBHOOK_SECRET }}

        steps:          
            - name: Check out main branch
              uses: actions/checkout@v3

            - name: Update SHA
              run: echo $GITHUB_SHA > $GITHUB_WORKSPACE/site/_meta

            - name: Build docker iamge
              run: docker build -t ${{ secrets.DO_REGISTRY_ENDPOINT }}/lostsonstv:$(echo $GITHUB_SHA | head -c7) .

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Log in to DigitalOcean Container Registry with short-lived credentials
              run: doctl registry login --expiry-seconds 600
              
            - name: Push image to DigitalOcean Container Registry
              run: docker push ${{ secrets.DO_REGISTRY_ENDPOINT }}/lostsonstv:$(echo $GITHUB_SHA | head -c7)

            
            - name: Update deployment file
              run: TAG=$(echo $GITHUB_SHA | head -c7) && sed -i 's|<IMAGE>|${{ secrets.DO_REGISTRY_ENDPOINT }}/lostsonstv:'${TAG}'|' $GITHUB_WORKSPACE/config/deployment.yml

            - name: Build docker image
              uses: docker/build-push-action@v5
              with:
                push: true
            